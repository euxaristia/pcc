#!/bin/bash
# PCC wrapper script - mimics gcc interface

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PCC_LIB_DIR="$SCRIPT_DIR/../lib/pcc"
PCC_BIN="$PCC_LIB_DIR/pcc"

# Detect project root and commit SHA
PROJ_ROOT="/home/euxaristia/Projects/pcc"
if [ -d "$PROJ_ROOT/.git" ]; then
    export PCC_COMMIT=$(git -C "$PROJ_ROOT" rev-parse --short HEAD 2>/dev/null || echo "unknown")
else
    export PCC_COMMIT="unknown"
fi

# Use native binary if available, otherwise fall back to bun
if [ -x "$PCC_BIN" ]; then
    PCC_RUN="$PCC_BIN"
elif [ -x "$PROJ_ROOT/pcc" ]; then
    PCC_RUN="$PROJ_ROOT/pcc"
else
    PCC_RUN="bun run $PROJ_ROOT/src/compile.ts"
fi

# Parse gcc-like arguments
SOURCE_FILE=""
OUTPUT_FILE=""
OUTPUT_FLAG=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -v|-V|--version)
            # Run the compiler with version flag and exit
            $PCC_RUN "$1"
            exit 0
            ;;
        -o)
            OUTPUT_FLAG="$2"
            shift 2
            ;;
        *.c)
            SOURCE_FILE="$1"
            shift
            ;;
        *)
            shift
            ;;
    esac
done

if [ -z "$SOURCE_FILE" ]; then
    echo "Usage: pcc <source-file.c> [-o output-file]"
    echo "Example: pcc hello.c -o hello"
    exit 1
fi

# Set output file
if [ -n "$OUTPUT_FLAG" ]; then
    OUTPUT_FILE="$OUTPUT_FLAG"
else
    OUTPUT_FILE="${SOURCE_FILE%.c}.o"
fi

# Run the compiler
$PCC_RUN "$SOURCE_FILE" > /dev/null

# Check if compilation succeeded
if [ $? -eq 0 ]; then
    # Link with system gcc to create executable
    OBJECT_FILE="${SOURCE_FILE%.c}.o"
    if [ -f "$OBJECT_FILE" ]; then
        gcc "$OBJECT_FILE" -o "$OUTPUT_FILE" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "Compilation successful: $OUTPUT_FILE"
        else
            echo "Compilation successful (object file only): $OBJECT_FILE"
        fi
    else
        echo "Compilation failed: no object file generated"
        exit 1
    fi
else
    echo "Compilation failed"
    exit 1
fi
